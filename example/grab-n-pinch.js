var e={add:(i,t)=>({x:i.x+t.x,y:i.y+t.y}),subt:(i,t)=>({x:i.x-t.x,y:i.y-t.y}),neg:i=>({x:-i.x,y:-i.y}),mult:(i,t)=>({x:i.x*t,y:i.y*t}),hypot:i=>(i.x**2+i.y**2)**.5,eq:(i,t)=>i===t?!0:!i||!t?!1:i.x===t.x&&i.y===t.y,from:({x:i,y:t})=>({x:i,y:t}),fromSize:i=>({x:i.width,y:i.height}),assignSize:(i,t)=>Object.assign(i,{width:t.x,height:t.y}),fromClientSize:i=>({x:i.clientWidth,y:i.clientHeight}),proceed:(i,t)=>{let n=e.from(i);return s=>e.assign(i,{x:n.x*(1-s)+t.x*s,y:n.y*(1-s)+t.y*s})},d:(i,t)=>e.hypot(e.subt(t,i)),assign:(i,t)=>(i.x=typeof t=="number"?t:t.x,i.y=typeof t=="number"?t:t.y,i),origin:{x:0,y:0},map:(i,t)=>({x:t(i.x),y:t(i.y)}),in:(i,t,n)=>t.x>=i.x&&t.x<n.x&&t.y>=i.y&&t.y<n.y,map2d:(i,t)=>i.map((n,s)=>n.map((a,r)=>t(a,{x:s,y:r}))),fill2d:(i,t)=>i.map(n=>n.map(()=>t)),get2d:(i,t)=>i[t.x][t.y],set2d:(i,t,n)=>{i[t.x][t.y]=n},in2d:(i,t)=>t.x>=0&&t.x<i.length&&t.y>=0&&t.y<i[i.length-1].length,from2dSize:i=>({x:i.length,y:i[0].length})};function h(i){if(!(i instanceof PointerEvent))throw new Error("Cannot handle event which is not pointer event");let t={x:i.x,y:i.y,timeStamp:i.timeStamp};return{...t,pointerId:i.pointerId,initial:t}}function u(i,t){return Object.assign(i,{x:t.x,y:t.y,timeStamp:t.timeStamp})}var c=class{translate={x:0,y:0};scale=1;pointers=[];maybeClick=!1;clicked=null;pointingContext=null;minScale=0;maxScale=1/0;constructor({translate:t,scale:n,minScale:s,maxScale:a}={}){n&&(this.scale=n),t&&(this.translate=t),s&&(this.minScale=s),a&&(this.maxScale=a)}viewportPoint=t=>e.mult(t,this.scale);drawingPoint=t=>e.map(e.mult(e.subt(t,this.translate),1/this.scale),Math.floor);addPointer=t=>{let n=h(t);this.pointers.push(n),!(this.pointers.length===0||this.pointers.length>2)&&(this.pointingContext={point0:e.from(n),translate0:e.from(this.translate),scale0:this.scale,pinch0:this.pointers.length===2?e.d(this.pointers[0],this.pointers[1]):0,vRefPointer:{...n},velocity:{x:0,y:0}},this.inertia=null,this.maybeClick=!0)};updatePointer=t=>{let n;for(let s=0;s<this.pointers.length;s+=1)if(this.pointers[s].pointerId===t.pointerId){n=Object.assign(this.pointers[s],{x:t.x,y:t.y,timeStamp:t.timeStamp});break}if(!(!n||!this.pointingContext||this.pointers.length===0||this.pointers.length>2))if(this.pointers.length===2){t.preventDefault(),this.maybeClick=!1;let{point0:s,translate0:a,scale0:r,pinch0:o}=this.pointingContext,l=e.d(this.pointers[0],this.pointers[1]);this.scale=Math.min(Math.max(this.minScale,r*(l/o)),this.maxScale),this.translate=e.add(s,e.mult(e.subt(a,s),l/o)),this.pointingContext.velocity={x:0,y:0}}else{let{vRefPointer:s}=this.pointingContext,a=n.timeStamp-s.timeStamp;a>16.6667&&(t.preventDefault(),this.maybeClick=!1,this.pointingContext.velocity=e.mult(e.subt(n,s),1/a),this.pointingContext.vRefPointer={...n}),e.assign(this.translate,e.add(this.pointingContext.translate0,e.subt(n,n.initial)))}};inertia=null;removePointer=t=>{let n=null;for(let s=0;s<this.pointers.length;s+=1)if(this.pointers[s].pointerId===t.pointerId){[n]=this.pointers.splice(s,1);break}if(this.pointers.length===2)t.preventDefault(),this.maybeClick=!1,this.pointingContext={point0:this.pointers[1],translate0:e.from(this.translate),scale0:this.scale,pinch0:e.d(this.pointers[0],this.pointers[1]),vRefPointer:{...this.pointers[1]},velocity:{x:0,y:0}};else if(this.pointers.length===1)t.preventDefault(),this.maybeClick=!1,this.pointers[0]={...this.pointers[0],timeStamp:t.timeStamp,initial:{...e.from(this.pointers[0]),timeStamp:t.timeStamp}},this.pointingContext={point0:e.from(this.pointers[0]),translate0:e.from(this.translate),scale0:this.scale,pinch0:0,vRefPointer:{...this.pointers[0]},velocity:{x:0,y:0}};else if(this.pointingContext){if(!this.maybeClick&&n){t.preventDefault();let{vRefPointer:s}=this.pointingContext,a=t.timeStamp-s.timeStamp;a>16.6667&&(this.pointingContext.velocity=e.mult(e.subt(t,s),1/a));let r=this.pointingContext?e.hypot(this.pointingContext.velocity):null;this.inertia=r!==null&&r>=.5?{p:0,v0:this.pointingContext.velocity,vqty:r}:null}this.maybeClick?this.pointingContext=null:this.clicked=null}};scaleInertia=null;updateScaleInertia=t=>{this.pointingContext&&e.assign(this.pointingContext.point0,t),this.scaleInertia||(this.scaleInertia={v:0,point0:e.from(t),translate0:e.from(this.translate),scale0:this.scale}),this.inertia&&(this.inertia=null),this.scaleInertia.v-=Math.sign(t.deltaY)*.5};run=t=>{if(this.inertia&&this.inertia.p<1){let n=e.mult(this.inertia.v0,1-this.inertia.p);e.assign(this.translate,e.add(this.translate,e.mult(n,t))),this.inertia.p+=t/(this.inertia.vqty*512),this.inertia.p>=1&&(this.inertia=null)}if(this.scaleInertia?.v){let{point0:n,translate0:s,scale0:a}=this.scaleInertia,r=this.scale*(1+this.scaleInertia.v*(t/128));this.scale=Math.min(Math.max(this.minScale,r),this.maxScale),this.translate=e.add(n,e.mult(e.subt(s,n),this.scale/a)),this.pointingContext&&Object.assign(this.pointingContext,{translate0:e.from(this.translate),scale0:this.scale});let o=this.scaleInertia.v-Math.sign(this.scaleInertia.v)*(t/128);this.scaleInertia.v=Math.max(-4,Math.min(o,4)),Math.abs(this.scaleInertia.v)<.1&&(this.scaleInertia=null)}}};export{c as GrabNPinchManager,h as mapEventToPointer,u as updatePointerByEvent};
//# sourceMappingURL=grab-n-pinch.js.map
